package com.maxim.core.service;

import com.maxim.api.model.CouponSales;
import com.maxim.api.model.RealTimeSalesData;
import com.maxim.api.service.CouponSalesService;
import com.maxim.api.service.OrdersExtraService;
import com.maxim.api.service.OrdersPayService;
import com.maxim.api.service.OrdersService;
import com.maxim.api.service.RealTimeService;
import com.maxim.common.exception.ValidationException;
import com.maxim.common.util.ValidationUtils;
import com.maxim.common.validation.Group;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.Resource;
import java.util.List;

@Transactional
@Service("realTimeService")
public class RealTimeServiceImpl implements RealTimeService {

    private static final Logger LOGGER = LoggerFactory.getLogger(RealTimeServiceImpl.class);

    @Resource(name = "ordersService")
    private OrdersService ordersService;

    @Resource(name = "ordersPayService")
    private OrdersPayService ordersPayService;

    @Resource(name = "ordersExtraService")
    private OrdersExtraService ordersExtraService;

    @Resource(name = "couponSalesService")
    private CouponSalesService couponSalesService;

    @Override
    public int add(RealTimeSalesData realTimeSalesData) {
        if (realTimeSalesData == null) {
            throw new ValidationException("[Validation failed] - this argument [realTimeSalesData] is required; it must not be null");
        }
        List<String> violations = ValidationUtils.validateObject(realTimeSalesData, Group.Add.class);
        if (!violations.isEmpty()) {
            throw new ValidationException("[Validation failed]:" + violations);
        }
        int count = 0;
        count += ordersExtraService.add(realTimeSalesData.getOrdersExtraList());
        count += ordersPayService.add(realTimeSalesData.getOrdersPayList());
        count += ordersService.add(realTimeSalesData.getOrdersList());
        List<CouponSales> couponSalesList = realTimeSalesData.getCouponSalesList();
        if (couponSalesList != null && couponSalesList.size() > 0) {
            count += couponSalesService.add(couponSalesList);
        }
        LOGGER.info("Successfully insert {} records, request data: {}", count, realTimeSalesData);
        return count;
    }

}
