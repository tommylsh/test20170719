package com.maxim.pos.sales.service;

import com.maxim.pos.common.entity.BranchMaster;
import com.maxim.pos.common.entity.BranchScheme;
import com.maxim.pos.common.enumeration.ClientType;
import com.maxim.pos.common.enumeration.Direction;
import com.maxim.pos.common.enumeration.MasterSyncType;
import com.maxim.pos.common.enumeration.PollSchemeType;
import com.maxim.pos.common.service.BranchMasterService;
import com.maxim.pos.common.service.PollBranchSchemeService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.Assert;

import java.util.List;

@Transactional
@Service("masterSyncToStgService")
public class MasterSyncToStgServiceImpl implements MasterSyncToStgService {

    private static final Logger LOGGER = LoggerFactory.getLogger(MasterSyncToStgService.class);

    @Autowired
    private PollBranchSchemeService pollBranchSchemeService;

    @Autowired
    private BranchMasterService branchMasterService;

    @Autowired
    private MasterService masterService;

    @Override
    public void processMasterDataToStg(MasterSyncType masterSyncType) {
        Assert.notNull(masterSyncType);
        MasterSyncType.Type type = masterSyncType.getType();
        if (type == MasterSyncType.Type.CODE) {
            String branchCode = masterSyncType.getValue();
            Assert.hasText(branchCode);
            BranchScheme branchScheme = pollBranchSchemeService.getBranchScheme(PollSchemeType.MASTER, Direction.MST_TO_STG, ClientType.SQLSERVER, branchCode);
            Assert.notNull(branchScheme);
            masterService.processMasterServerToStaging(branchScheme, LOGGER);
            return;
        }

        if (type == MasterSyncType.Type.TYPE) {
            String branchType = masterSyncType.getValue();
            Assert.hasText(branchType);
            List<BranchMaster> branchMasterList = branchMasterService.getBranchMasterList(branchType);
            for (BranchMaster branchMaster : branchMasterList) {
                BranchScheme branchScheme = pollBranchSchemeService.getBranchScheme(PollSchemeType.MASTER, Direction.MST_TO_STG, ClientType.SQLSERVER, branchMaster.getBranchCode());
                masterService.processMasterServerToStaging(branchScheme, LOGGER);
            }
            return;
        }

        List<BranchMaster> branchMasterList = branchMasterService.getBranchMasterList();
        for (BranchMaster branchMaster : branchMasterList) {
            BranchScheme branchScheme = pollBranchSchemeService.getBranchScheme(PollSchemeType.MASTER, Direction.MST_TO_STG, ClientType.SQLSERVER, branchMaster.getBranchCode());
            masterService.processMasterServerToStaging(branchScheme, LOGGER);
        }
    }

}
