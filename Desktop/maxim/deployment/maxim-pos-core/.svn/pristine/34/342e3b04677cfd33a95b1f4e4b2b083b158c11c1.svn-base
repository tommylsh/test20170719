package com.maxim.pos.test.common.service;

import java.io.FileOutputStream;
import java.io.InputStream;
import java.lang.reflect.InvocationTargetException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.commons.beanutils.BeanUtils;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.env.StandardEnvironment;
import org.springframework.core.io.FileSystemResource;
import org.springframework.mail.MailSender;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.transaction.TransactionConfiguration;
import org.springframework.util.StringUtils;

import com.luhuiguo.chinese.ChineseUtils;
import com.maxim.dao.QueryFileHandler;
import com.maxim.pos.common.entity.SchemeInfo;
import com.maxim.pos.common.entity.SchemeTableColumn;
import com.maxim.pos.common.enumeration.ClientType;
import com.maxim.pos.common.enumeration.PollSchemeType;
import com.maxim.pos.common.persistence.PollSchemeInfoDao;
import com.maxim.pos.common.persistence.SchemeJobLogDao;
import com.maxim.pos.common.persistence.SchemeTableColumnDao;
import com.maxim.pos.common.persistence.TaskJobLogDao;
import com.maxim.pos.common.service.ApplicationSettingService;
import com.maxim.pos.common.service.ChineseConverionServiceImpl;
import com.maxim.pos.common.service.PollSchemeInfoService;
import com.maxim.pos.common.service.SchemeTableColumnService;
import com.maxim.pos.master.persistence.BranchInventoryInfoDao;
import com.maxim.pos.report.service.ReportService;
import com.maxim.pos.sales.persistence.SchemeInfoDao;
import com.maxim.pos.sales.service.BranchInfoService;
import com.maxim.pos.sales.service.MasterServiceImpl;
import com.maxim.pos.security.entity.User;
import com.maxim.util.EncryptionUtil;

import jcifs.smb.NtlmPasswordAuthentication;
import jcifs.smb.SmbFile;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "classpath*:pos-core-context.xml" })
@TransactionConfiguration(transactionManager = "transactionManager", defaultRollback = true)
public class SchemeTableColumnGenerationTest {

    @Autowired
    private PollSchemeInfoService pollSchemeInfoService;
    
    @Autowired
    private SchemeTableColumnService schemeTableColumnService;
    
    @Autowired
    private BranchInfoService branchInfoService;
    
    @Autowired
    private QueryFileHandler queryFileHandler;
    
    @Autowired
    private ApplicationSettingService applicationSettingService;
    
    @Autowired
    private PollSchemeInfoDao pollSchemeInfoDao;

    @Autowired
    private com.mchange.v2.c3p0.ComboPooledDataSource dataSource;
    
	@Autowired
	private MailSender mailSender;
    
	@Autowired
	private String  mailSenderAddress;
	
	@Autowired
	private SchemeTableColumnDao  schemeTableColumnDao;
	
	@Autowired
	private ReportService reportService;

	@Autowired
	private BranchInventoryInfoDao branchInventoryInfoDao ;
	@Autowired
	private MasterServiceImpl masterService;
	
    
    protected @Value("${sales.enableArchive}") boolean enableArchive ;

	
	private @Value("${connection.username}") String username;
	
	private @Value("${aesKey}") String asekey;
	
    public Logger logger;
    
	@Autowired
	private TaskJobLogDao  taskJobLogDao;
	 
	@Autowired
	private SchemeInfoDao  schemeInfoDao;
	
	@Autowired
	private SchemeJobLogDao schemeJobLogDao;
	
	@Autowired
	private ChineseConverionServiceImpl chineseConverionService;
	
	@Resource(name="systemPrincipal")
	private User systemPrincipal;

	private @Value("${system.eod.batchProcessSize}") int eodBatchProcessSize;
	private @Value("${system.realTime.batchProcessSize}") int realTimeBatchProcessSize;
	private @Value("${system.master.batchProcessSize}") int masterBatchProcessSize;
	private @Value("${system.other.batchProcessSize}") int otherBatchProcessSize;

	public Map<String, Boolean> eodPriorityMap = new HashMap<String, Boolean>();

    
    @Before
    public void setup() {
        logger = LoggerFactory.getLogger(getClass());
        logger.info("setup at : {}", new Date());
    }
    
    @Test
//    @Transactional
    public void getTableColumnInfoTest() throws IllegalAccessException, InvocationTargetException, NoSuchMethodException{

    	if (1==1){
    		
    		masterService.getClass();
    		chineseConverionService.getClass();
//    		String str = "枫糖甜心酥";
    		String str = "广州东站(3线)饼店";
    		
    		System.out.println(str);
    		String str2 = ChineseUtils.toTraditional(str);
    	    		System.out.println(str2);
//    		BranchScheme branchScheme = new BranchScheme();
//    		branchScheme.setPollSchemeType(PollSchemeType.REPORT);
//    		branchScheme.setDirection(Direction.DAYEND_REPORT);
//    		reportService.sendReportMail(branchScheme, logger);
//    		
//    		this.branchInventoryInfoDao.findAll();
//    		BranchInventoryInfo info = new BranchInventoryInfo();
//    		info.setBranchCode("XXXX");
//    		info.setBusinessDate(java.sql.Date.valueOf("2017-01-01"));
//    		
//    		info = this.branchInventoryInfoDao.find(info);
//    		System.out.println(info);
//    		
//    		info = new BranchInventoryInfo();
//    		info.setBranchCode("XXXX");
//    		info.setBusinessDate(java.sql.Date.valueOf("2017-01-01"));
//    		info.setLastUpdateDateTime(new java.util.Date());
//    		
//    		this.branchInventoryInfoDao.insert(info);
//    		System.out.println(info);
//
//    		info = this.branchInventoryInfoDao.find(info);
//    		System.out.println(info);
//    		
//    		List dates = this.branchInventoryInfoDao.getPosEODStockDateList("XXXX", java.sql.Date.valueOf("2015-01-01"));
//
//    		System.out.println(dates);
//    		
//    		info.setLastUpdateDateTime(new java.util.Date());
//    		this.branchInventoryInfoDao.update(info);
//    		System.out.println(info);
//    		
//    		this.branchInventoryInfoDao.delete(info);
//    		System.out.println(info);
//    		
//    		
//    		System.out.println("username : " +enableArchive);
//    		System.out.println("username : " +username);
//    		System.out.println("username : " +systemPrincipal.getUserId());
//    		System.out.println("username : " +Auditer.systemPrincipal.getUserId());
//    		
////    		List list = taskJobLogDao.findLatestPollBrachScheme(PollSchemeType.SALES_EOD, Direction.POS_TO_STG);
//    		List<Map<String, Object>> list = schemeInfoDao.findLatestPollBrachScheme(PollSchemeType.SALES_EOD, Direction.POS_TO_STG);
//    		
//    		System.out.println(schemeJobLogDao.findLatestSchemeJobLog(30L, "MAX_POS_SYSTEM_2"));
//    		System.out.println(schemeJobLogDao.countCreateUserByScheduleJobIdAndCreateUser(30L, "MAX_POS_SYSTEM_2"));
//    		
//    		eodPriorityMap.put("4117", true);
//    		eodPriorityMap.put("4459", true);
//    		System.out.println("list : " +list.size());
//    		List<Map<String, Object>> newList = new ArrayList<Map<String, Object>>(list.size());
//    		
//    		
//			System.out.println("eodPriorityMap : " + eodPriorityMap);
//            Collections.sort(list, new Comparator<Map<String, Object>>()
//    			{
//					@Override
//					public int compare(Map<String, Object> map1 ,Map<String, Object> map2) {
//			            String branchCode1 = (String) map1.get("branchCode");
//			            String branchCode2 = (String) map2.get("branchCode");
//						if (eodPriorityMap.containsKey(branchCode1))
//							return eodPriorityMap.containsKey(branchCode2) ? 0 : -1 ;
//						else
//							return eodPriorityMap.containsKey(branchCode2) ? 1 : 0 ;
//					}
//    			}
//            );
//
//    		for (Object o : list)
//    		{
//    			System.out.println(o.getClass() + " : " + o);
//    			
//    			Map<String, Object> map = (Map<String, Object>) o ; 
//    			Map<String, Object> newMap = new HashMap<String, Object>(); 
//    			for (String key : map.keySet())
//    			{
//    				Object value = map.get(key) ;
//    				if (value != null)
//    				{
//    					System.out.println(key + " : " + value.getClass() + " : " + value);
//    				}
//    				else
//    				{
//    					System.out.println(key + " : " + value);
//    				}
//    				if (key.equals("isEnabled"))
//    				{
//    					System.out.println(key + " : " + ((byte)value));
//    				}
//    				if (value != null)
//    					newMap.put(key, value);
//    			}
//    			newList.add(newMap);
//    		}
//    		
//    		for (Object o : newList)
//    		{
//    			System.out.println(o.getClass() + " : " + o);
//    			
//    			Map<String, Object> map = (Map<String, Object>) o ; 
//    		
//            	BranchScheme branchScheme = new BranchScheme() ;
//            	BeanUtils.populate(branchScheme, map);
//
//            	
//    			System.out.println(BeanUtils.describe(branchScheme));
//
//    		}
    		
    		
    		return ;
    	}
    	if (1==1){
			 SimpleMailMessage message = new SimpleMailMessage();
			  
			  message.setFrom(mailSenderAddress);
			  message.setTo("tommy.leung@buzz-it.com.hk");
			  message.setSubject("testing");

			  message.setText("Test 123");
			  
			  mailSender.send(message);
    		System.out.println(dataSource.getJdbcUrl());
    		System.out.println(dataSource.getUser());
    		System.err.println(dataSource.getJdbcUrl());
    		System.err.println(dataSource.getUser());
    		System.err.println(dataSource.getInitialPoolSize());
    		System.err.println(dataSource.getMaxPoolSize());
//    		System.err.println(dataSource.getUser());
//    		System.err.println(dataSource.getUser());
    		
    		
    		return ;
    		
    	}

    	if (1==1){
    		SchemeInfo schemeInfo = pollSchemeInfoDao.getById((long) 105);
			System.out.println("Poll Scheme Info ID = " + schemeInfo.getId() + "; table = " + schemeInfo.getDestination());
			List<SchemeTableColumn> schemeTableColumnList = pollSchemeInfoService.generateSchemeTableColumnData(schemeInfo);
	    	System.out.println("Scheme Table Column List Size = " + schemeTableColumnList.size());
	    	schemeTableColumnService.saveSchemeTableColumns(schemeTableColumnList);
	    	
//			for(SchemeTableColumn schemeTableColumn: schemeTableColumnList){
//				System.out.println(schemeTableColumn.getFromColumnInfo());
//				System.out.println(schemeTableColumn.getFromColumnInfo());
//			}

	    	return ;
    	}
    	
		List<SchemeInfo> schemeInfoList = pollSchemeInfoService.findSchemeInfoBySchemeTypeAndClientType(PollSchemeType.SALES_EOD, ClientType.CSV);
		System.out.println("getTableColumnInfoTest size : " +schemeInfoList.size());
		for (SchemeInfo schemeInfo : schemeInfoList){

			
			System.out.println("schemeInfo : " + BeanUtils.describe(schemeInfo).toString() ) ;

//			if(schemeInfo.getClientType().equals(ClientType.DBF)
//					&& schemeInfo.getPollSchemeType().equals(PollSchemeType.SALES_EOD)
//					&& schemeInfo.getDestination().equalsIgnoreCase("hist_orders"))
			{
				System.out.println("Poll Scheme Info ID = " + schemeInfo.getId() + "; table = " + schemeInfo.getDestination());
				List<SchemeTableColumn> schemeTableColumnList = pollSchemeInfoService.generateSchemeTableColumnData(schemeInfo);
		    	System.out.println("Scheme Table Column List Size = " + schemeTableColumnList.size());
		    	schemeTableColumnService.saveSchemeTableColumns(schemeTableColumnList);
			}
		}

    }
    
    public  static void main(String[] arg) throws Exception
    {
    	if (1==1)
    	{
    		StandardEnvironment e = new StandardEnvironment();
    		System.out.println(e.resolvePlaceholders("file:C:/UserData/weblogic/chinese_conversion_table.json"));
    		FileSystemResource resource = new FileSystemResource("file:C:/UserData/weblogic/chinese_conversion_table.json");
    		System.out.println(resource.exists());
    		System.out.println(resource.getFilename());
    		System.out.println(resource.getPath());
    		System.out.println(resource.getFile().exists());
    		System.out.println(resource.getFile().getCanonicalPath());
    		
    		String str = "广州东站(3线)饼店";
    		
    		System.out.println(str);
    		String str2 = ChineseUtils.toTraditional(str);
    	    		System.out.println(str2);
    	    		
    		System.out.println(EncryptionUtil.aesEncrypt("P@ssw0rd1234" , "90206f7a4fc149b592a14b7629caad5e"));
    		System.out.println(EncryptionUtil.aesEncryptToBytes("P@ssw0rd1234" , "90206f7a4fc149b592a14b7629caad5e"));
    		
    		String txt="M{BB}M";
    		System.out.println(txt.replaceAll("/^BB/", "A"));
    		
    		System.out.println(StringUtils.replace(txt, "{BB}", "A"));
    				
			return ;
    	}
    	if (1==1)
    	{


			  
			String url = "smb://10.20.30.166/export/6101/";
			NtlmPasswordAuthentication auth = new NtlmPasswordAuthentication(null, "poll", "poll12345");
		       List<SmbFile> fileList = new ArrayList<SmbFile>();

				byte[] bs= new byte[1024];
			SmbFile dir = new SmbFile(url, auth);
			for (SmbFile file : dir.listFiles())
			{
				fileList.add(file);
			    System.out.println(file.getCanonicalPath());
			    if (file.getName().equals("M6101_000000_TRANSMODI.DBF"))
			    {
			    
	    		   FileOutputStream f = new FileOutputStream("C:/UserData/"+file.getName());
	    		   InputStream in = file.getInputStream();
	    		   int i = in.read(bs);
	    		   while (i > 0)
	    		   {
	    			   f.write(bs, 0, i);
	    			   i = in.read(bs);
	    		   }
	    		   f.close();
	    		   in.close();
	    		   
	    		   file.delete();
			    }

			}

		       for (SmbFile file : fileList)
		       {
	    		   file.getInputStream().reset();
	    		   
	    		   
	    	  }
			return ;
    	}
    	
        SimpleDateFormat dateFormat = new SimpleDateFormat("yyMMdd");
        System.out.println(dateFormat.parse("170908"));
    	String[] dates = new String[] {"111","222"};
    	int idx = 0;
    	StringBuffer dateStrBuf = new StringBuffer("(");
    	for (String date : dates)
    	{
    		System.out.println(idx);
    		System.out.println(dates.length);
    		System.out.println(date);
    		dateStrBuf.append("'").append(date);
    		if (++idx == dates.length)
    		{
    			dateStrBuf.append("')");
    		}
    		else
    		{
    			dateStrBuf.append("',");
    		}
    	}
    	
    	System.out.println(dateStrBuf.toString());
    	
    	return ;
    }
    
//    @Test
//    @Transactional
//    public void addPollSchmeInfoTest(){
//
//    }
//    
//    @Test
//    @Transactional
//    public void batchSizeValidationTest(){
//    	Integer batchSize = new Integer(1000);
//    	System.out.println(batchSize > 900);
//    	
//    	String str = "1001";
//    	Integer newBatchSize = Integer.valueOf(str);
//    	System.out.println(newBatchSize.compareTo(batchSize));
//    	System.out.println(newBatchSize);
//    }
}
