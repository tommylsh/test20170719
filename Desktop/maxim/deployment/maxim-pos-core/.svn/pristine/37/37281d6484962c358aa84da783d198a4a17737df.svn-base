package com.maxim.pos.common.persistence;

import java.sql.Connection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import com.maxim.dao.HibernateEntityDAO;
import com.maxim.pos.common.entity.BranchInfo;
import com.maxim.pos.common.entity.BranchScheme;
import com.maxim.pos.common.entity.PollEodControl;
import com.maxim.pos.common.service.ApplicationSettingService;
import com.maxim.pos.common.util.LogUtils;
import com.maxim.pos.common.util.PosClientUtils;

@Repository("pollEodControlDao")
public class PollEodControlDao  extends HibernateEntityDAO<PollEodControl, Long>  {
	
	private static final String HQL_findPollEodControlByBranchCode = "findPollEodControlByBranchCode"; 

	@Autowired
	private ApplicationSettingService applicationSettingService;
	
	public void saveOrUpdateConvertLog(PollEodControl pollEodControl){
		save(pollEodControl);
	}

	public PollEodControl findLatestPollEodControl(String branchCode, String status) {
	    Map<String, Object> paramMap = new HashMap<String, Object>();
        paramMap.put("branchCode", branchCode);
//        paramMap.put("businessDate", businessDate);
        paramMap.put("status", status);
        
        paramMap.put(MAX_RESULT_KEY, 1);

        List<PollEodControl> list =  getListByQueryKey(HQL_findPollEodControlByBranchCode, paramMap);
        
//        List<PollEodControl> list = getList(new PosDaoCmd(HQL_findPollEodControlByBranchCode, paramMap), PollEodControl.class);
        
        if(list.size()>0){
	        PollEodControl pollEodControl = list.get(0);
	        if(pollEodControl != null){
	        	return pollEodControl;	
	        }
        }
        return null;
	}
	
	
	public boolean findConvertLogByBusinessDate(BranchScheme branchScheme, String dateStr) {
	    BranchInfo branchInfo = branchScheme.getBranchInfo();
	    String branchCode = branchScheme.getBranchMaster().getBranchCode();
		LogUtils.printLog("findConvertLogByBusinessDate {}",branchCode );
	    try(Connection connection = applicationSettingService.getJDBCConection(branchInfo, true)){
//	        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
//			String datetime =sdf.format(new Date());
//	    	String datetime = DateUtil.getCurrentDateString();
	    	String query ="select count(*) as SS from CONVERT_LOG where TO_CHAR(TTDATE,'yyyy-MM-dd') = '"+dateStr+"' and BRNO = '"+branchCode+"'";
			LogUtils.printLog("findConvertLogByBusinessDate query {} ",query  );
	    	List<Map<String, Object>> list = PosClientUtils.execCliectQuery(connection, query, false);
			LogUtils.printLog("findConvertLogByBusinessDate query {} ",query  );
	    	Object obj = list.size() == 0 ? "0" : list.get(0).get("SS");
	    	if(Integer.parseInt(obj.toString()) > 0){
	    		return true;
	    	}
	    }catch (Exception e) {
			LogUtils.printException("select convert_log fail", e);
		}
        return false;
	}
	
//	public boolean findPollEodControlByBranchCodeAndDate(String branchCode) {
//		boolean bl =false;
//		Map<String, Object> paramMap = new HashMap<String,Object>();
//		paramMap.put("branchCode", branchCode);
//		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
//		String datetime =sdf.format(new Date());
//		paramMap.put("businessDate",datetime);
//        PosDaoCmd cmd = new PosDaoCmd(HQL_findPollEodControlByBranchCode, paramMap);
//        List<PollEodControl> list = getList(cmd, PollEodControl.class);
//		if(list.size()>0){
//			bl=true;
//		}
//        return bl;
//	}
}
